# Multi-stage Dockerfile for testing
# Stage 1: Production dependencies only
FROM python:3.12-slim-bookworm AS production
WORKDIR /app

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# Copy project files
COPY pyproject.toml uv.lock /app/

# Install production dependencies only
RUN uv sync --no-dev --frozen

# Copy source code
COPY src/ /app/src/

# Stage 2: Development dependencies and testing
FROM python:3.12-slim-bookworm AS test
WORKDIR /app

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# Copy project files
COPY pyproject.toml uv.lock /app/

# Install all dependencies including dev dependencies
RUN uv sync --group dev --frozen

# Copy source code and tests
COPY src/ /app/src/
COPY tests/ /app/tests/

# Set Python path
ENV PYTHONPATH=/app/src/app

# Default command to run tests
CMD ["uv", "run", "pytest", "tests/", "--cov=app", "--cov-report=xml", "--cov-report=html:coverage_html", "--cov-report=term"]
